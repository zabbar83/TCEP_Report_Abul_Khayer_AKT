select  
        DISTINCT
        vta.WING_ID wingId,
        vta.WING_NAME wingName,
        vta.DIVISION_ID divisionId,
        vta.DIVISION_NAME divisionName,
        vta.TERITORY_ID teritoryId,
        vta.TERITORY_NAME teritoryName,
        bru.user_name userName,
        bru.br_name brName,
        bru.status attenStatus,
        statusNo * 30 contactTarget,
        NVL(bac.regMax10s,0) regMax10s,
        NVL(bac.regMax20s,0) regMax20s,
        NVL(bac.bolMax10s,0) bolMax10s,
        NVL(bac.bolMax20s,0) bolMax20s,
        NVL(bac.total_con,0) totalCon,
        ROUND(case when statusNo * 30 > 0 then (NVL(bac.total_con,0)/(statusNo * 30)) * 100  else 0 end,2) totalConAch,
        statusNo * 30 swappingTarget,
        NVL(bac.regSwaMax,0) regSwaMax,
        NVL(bac.bolSwaMax,0) bolSwaMax,
        NVL(bac.swappingcon,0) swappingcon,
        ROUND(case when statusNo * 30 > 0 then (NVL(bac.swappingcon,0)/(statusNo * 30)) * 100  else 0 end,2) swappingAch,
        
        statusNo * 30 samplingTarget,
        NVL(bac.regSamMax,0) regSamMax,
        NVL(bac.bolSamMax,0) bolSamMax,
        NVL(bac.samplingCon,0) samplingCon,
        ROUND(case when statusNo * 30 > 0 then (NVL(bac.samplingCon,0)/(statusNo * 30)) * 100  else 0 end,2) samplingAch,
        
        statusNo * 7 vao5sTarget,
        NVL(vaoLig5s,0)vaoLig5s,
        NVL(vaoBan10s,0)vaoBan10s,
        NVL(vaoDeo10s,0)vaoDeo10s,
        NVL(vaoBan20s,0)vaoBan20s,
        NVL(vaoDeo20s,0)vaoDeo20s,
        NVL(bac.vaoTotal,0) vaoTotal,
        ROUND(case when statusNo * 7 > 0 then (NVL(bac.vaoTotal,0)/(statusNo * 7)) * 100  else 0 end,2) vaoTotalAch
from    (select * from v_teritory_all
where   division_id like :divisionId || '%'
and     teritory_id like :teritoryId || '%')vta
JOIN    (
        select  
        bu.teritory_id,
        br_user,
        bu.user_name,
        br.name br_name,
        status,
        case when status='PRESENT' then 1 else 0 end statusNo,
        att_time
from
       ((SELECT ba.BR_USER_USER_ID br_user, 'PRESENT' status, TO_CHAR(ba.ATTENDANCE_DATE_TIME, 'dd-mm-yyyy') att_time
        FROM BRUSER_ATTENDANCE ba  
        WHERE TO_CHAR(ba.ATTENDANCE_DATE_TIME, 'dd-mm-yyyy')=:targetDate)
        UNION all
        (SELECT bul.BR_USER_USER_ID br_user,'ABSENT' status, TO_CHAR(bul.LEAVE_DATE_TIME, 'dd-mm-yyyy') att_time
        FROM BR_USER_LEAVE bul 
        WHERE TO_CHAR(bul.LEAVE_DATE_TIME, 'dd-mm-yyyy')=:targetDate)) br_user
        JOIN BRUSER_ROLES br ON br_user.br_user = br.BRUSER_USER_ID
        and  ROLES_ID=14
        JOIN BRUSER bu ON br_user.br_user = bu.USER_ID 
        AND bu.IS_ACCOUNT_NON_EXPIRED = 1
        JOIN brand_representative br on bu.user_id=br.br_user_user_id
        ) bru
        ON vta.teritory_id=bru.teritory_id
LEFT    JOIN (select  ba.br_user_id,
                count(distinct (case when ba.offered_brand = 47 then ba.id else null end)) regMax10s,
                count(distinct (case when ba.offered_brand = 48 then ba.id else null end)) regMax20s,
                count(distinct (case when ba.offered_brand = 49 then ba.id else null end)) bolMax10s,
                count(distinct (case when ba.offered_brand = 50 then ba.id else null end)) bolMax20s,
                count(distinct (case when ba.offered_brand IN (47,48,49,50) then ba.id else null end)) total_con,
                sum(case when ba.offered_brand IN (47,48) then swapping_no else 0 end) regSwaMax,
                sum(case when ba.offered_brand IN (49,50) then swapping_no else 0 end) bolSwaMax,
                sum(case when ba.offered_brand IN (47,48,49,50) and swapping_no > 0 then 1 else 0 end) swappingCon,
                sum(case when ba.offered_brand IN (47,48) then SAMPLING_NO else 0 end) regSamMax,
                sum(case when ba.offered_brand IN (49,50) then SAMPLING_NO else 0 end) bolSamMax,
                sum(case when ba.offered_brand IN (47,48,49,50) and SAMPLING_NO > 0 then 1 else 0 end) samplingCon,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.product_quantity = 5 and vs.GIFT_ITEM_ID =17 then vs.quantity else 0 end) vaoLig5s,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.GIFT_ITEM_ID=49 and vs.product_quantity = 10 then vs.quantity else 0 end) vaoBan10s,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.GIFT_ITEM_ID=35 and vs.product_quantity = 10 then vs.quantity else 0 end) vaoDeo10s,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.GIFT_ITEM_ID=49 and vs.product_quantity = 20 then vs.quantity else 0 end) vaoBan20s,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.GIFT_ITEM_ID=35 and vs.product_quantity = 20 then vs.quantity else 0 end) vaoDeo20s,
                sum(case when ba.offered_brand IN (47,48,49,50) and vs.GIFT_ITEM_ID IN (17,35,49) then vs.quantity else 0 end) vaoTotal
        from    (select * from bractivity where TO_CHAR(TARGET_DATE, 'dd-mm-yyyy')=:targetDate) ba
        LEFT    JOIN vao_sale vs on ba.id=vs.bractivity_id
        group   by ba.br_user_id
        ) bac
        ON bru.br_user=bac.br_user_id
ORDER   by vta.WING_ID, vta.DIVISION_ID, vta.TERITORY_ID, bru.user_name