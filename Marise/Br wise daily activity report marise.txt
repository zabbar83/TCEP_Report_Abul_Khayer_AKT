select  
        DISTINCT
        vta.WING_ID wingId,
        vta.WING_NAME wingName,
        vta.DIVISION_ID divisionId,
        vta.DIVISION_NAME divisionName,
        vta.TERITORY_ID teritoryId,
        vta.TERITORY_NAME teritoryName,
        bru.user_name userName,
        bru.br_name brName,
        bru.status attenStatus,
        statusNo * 40 contactTarget,
        NVL(bac.msb10s,0) msb10s,
        NVL(bac.msb20s,0) msb20s,
        NVL(bac.total_con,0) totalCon,
        ROUND(case when statusNo * 40 > 0 then (NVL(bac.total_con,0)/(statusNo * 40)) * 100  else 0 end,2) totalConAch,
        statusNo * 3 vao10sTarget,
        NVL(bac.vao10sBraMatch,0) vao10sBraMatch,
        ROUND(case when statusNo * 3 > 0 then (NVL(bac.vao10sBraMatch,0)/(statusNo * 3)) * 100  else 0 end,2) vao10sAch,
        
        statusNo * 2 vao20sTarget,
        NVL(bac.vao20sPerfume,0) vao20sPerfume,
        ROUND(case when statusNo * 2 > 0 then (NVL(bac.vao20sPerfume,0)/(statusNo * 2)) * 100  else 0 end,2) vao20sAch,
        
        statusNo * 5 vaoTarget,
        NVL(vaoTotalGiftBox,0)vaoTotalGiftBox,
        ROUND(case when statusNo * 5 > 0 then (NVL(bac.vaoTotalGiftBox,0)/(statusNo * 5)) * 100  else 0 end,2) vaoTotalAch
        
from    (select * from v_teritory_all
where   division_id like :divisionId || '%'
and     teritory_id like :teritoryId || '%')vta
JOIN    (
        select  
        bu.teritory_id,
        br_user,
        bu.user_name,
        br.name br_name,
        status,
        case when status='PRESENT' then 1 else 0 end statusNo
from
       ((SELECT ba.BR_USER_USER_ID br_user, 'PRESENT' status
        FROM BRUSER_ATTENDANCE ba  
        WHERE TO_CHAR(ba.ATTENDANCE_DATE_TIME, 'DD-MON-YY')=:targetDate)
        UNION all
        (SELECT bul.BR_USER_USER_ID br_user,'ABSENT' status
        FROM BR_USER_LEAVE bul 
        WHERE TO_CHAR(bul.LEAVE_DATE_TIME, 'DD-MON-YY')=:targetDate)) br_user
        JOIN BRUSER_ROLES br ON br_user.br_user = br.BRUSER_USER_ID
        and  ROLES_ID=14
        JOIN BRUSER bu ON br_user.br_user = bu.USER_ID 
        AND bu.IS_ACCOUNT_NON_EXPIRED = 1
        JOIN brand_representative br on bu.user_id=br.br_user_user_id
        ) bru
        ON vta.teritory_id=bru.teritory_id
LEFT    JOIN (select  ba.br_user_id,
                count(distinct (case when ba.offered_brand = 4 then ba.id else null end)) msb10s,
                count(distinct (case when ba.offered_brand = 5 then ba.id else null end)) msb20s,
                count(distinct (case when ba.offered_brand IN (4,5) then ba.id else null end)) total_con,
                sum(case when ba.offered_brand IN (4,5) and vs.product_quantity = 10 and vs.GIFT_ITEM_ID =15 then vs.quantity else 0 end) vao10sBraMatch,
                sum(case when ba.offered_brand IN (4,5) and vs.product_quantity = 20 and vs.GIFT_ITEM_ID =50 then vs.quantity else 0 end) vao20sPerfume,
                sum(case when ba.offered_brand IN (4,5) and vs.product_quantity IN (10, 20) and vs.GIFT_ITEM_ID IN (15, 50) then vs.quantity else 0 end) vaoTotalGiftBox
        from    (select * from bractivity where TARGET_DATE=:targetDate) ba
        LEFT    JOIN vao_sale vs on ba.id=vs.bractivity_id
        group   by ba.br_user_id
        ) bac
        ON bru.br_user=bac.br_user_id
ORDER   by vta.WING_ID, vta.DIVISION_ID, vta.TERITORY_ID, bru.user_name